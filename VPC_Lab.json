{

"AWSTemplateFormatVersion" : "2010-09-09",

"Description" : "VPC with 4 subnets across 2 Availability Zones.",

}
"Parameters" : {

"NATInstanceType" : {

"Description" : "NAT EC2 instance type",

"Type" : "String",

"Default" : "m1.small",

"AllowedValues" : [ "m1.small","m1.medium" ]

},

"CorporateCidrIp" : {

"Description" : "Your Company's CidrIp (to restrict traffic to be authorized ONLY from corporate office)",

"Type" : "String",

"Default" : "0.0.0.0/0"

}

},
"Mappings" : {
    "AWSInstanceType2Arch" : {
      "m1.small"   : { "Arch" : "64" },
      "m1.medium"  : { "Arch" : "64" },
      "m1.large"   : { "Arch" : "64" },
      "m1.xlarge"  : { "Arch" : "64" },
      "m2.xlarge"  : { "Arch" : "64" },
      "m2.2xlarge" : { "Arch" : "64" },
      "m2.4xlarge" : { "Arch" : "64" },
      "m3.xlarge"  : { "Arch" : "64" },
      "m3.2xlarge" : { "Arch" : "64" },
      "c1.medium"  : { "Arch" : "64" },
      "c1.xlarge"  : { "Arch" : "64" }
    },
    "AWSRegionArch2AMI" : {
      "us-east-1"      : {"64" : "ami-f619c29f"},
      "us-west-2"      : {"64" : "ami-52ff7262"},
      "us-west-1"      : {"64" : "ami-3bcc9e7e"},
      "eu-west-1"      : {"64" : "ami-e5e2d991"},
      "ap-southeast-1" : {"64" : "ami-02eb9350"},
      "ap-southeast-2" : {"64" : "ami-ab990e91"},
      "ap-northeast-1" : {"64" : "ami-14d86d15"},
      "sa-east-1"      : {"64" : "ami-0039e61d"}
    }
  },
  Resources : {

  }
  "VPC" : {
        "Type" : "AWS::EC2::VPC",
        "Properties" : {
          "CidrBlock" : "10.0.0.0/16"
        }
      },
      "InternetGateway" : {
            "Type" : "AWS::EC2::InternetGateway",
            "Properties" : {
            }
          },

          "AttachGateway" : {
             "Type" : "AWS::EC2::VPCGatewayAttachment",
             "Properties" : {
               "VpcId" : { "Ref" : "VPC" },
               "InternetGatewayId" : { "Ref" : "InternetGateway" }
             }
          },
          "PublicSubnet1" : {
                "Type" : "AWS::EC2::Subnet",
                "Properties" : {
                  "VpcId" : { "Ref" : "VPC" },
                  "CidrBlock" : "10.0.0.0/24",
                  "AvailabilityZone" : { "Fn::Select" : [ "0", { "Fn::GetAZs" : "" } ] }
                }
              },

              "PublicSubnet2" : {
                "Type" : "AWS::EC2::Subnet",
                "Properties" : {
                  "VpcId" : { "Ref" : "VPC" },
                  "CidrBlock" : "10.0.10.0/24",
                  "AvailabilityZone" : { "Fn::Select" : [ "1", { "Fn::GetAZs" : "" } ] }
                }
              },

              "PrivateSubnet1" : {
                "Type" : "AWS::EC2::Subnet",
                "Properties" : {
                  "VpcId" : { "Ref" : "VPC" },
                  "CidrBlock" : "10.0.1.0/24",
                  "AvailabilityZone" : { "Fn::Select" : [ "0", { "Fn::GetAZs" : "" } ] }
                }
              },

              "PrivateSubnet2" : {
                "Type" : "AWS::EC2::Subnet",
                "Properties" : {
                  "VpcId" : { "Ref" : "VPC" },
                  "CidrBlock" : "10.0.11.0/24",
                  "AvailabilityZone" : { "Fn::Select" : [ "1", { "Fn::GetAZs" : "" } ] }
                }
              },
              "PublicRouteTable" : {
                    "Type" : "AWS::EC2::RouteTable",
                    "Properties" : {
                      "VpcId" : {"Ref" : "VPC"}
                    }
                  },

                  "PrivateRouteTable" : {
                    "Type" : "AWS::EC2::RouteTable",
                    "Properties" : {
                      "VpcId" : {"Ref" : "VPC"}
                    }
                  },
                  "PublicRoute" : {
                        "Type" : "AWS::EC2::Route",
                        "Properties" : {
                          "RouteTableId" : { "Ref" : "PublicRouteTable" },
                          "DestinationCidrBlock" : "0.0.0.0/0",
                          "GatewayId" : { "Ref" : "InternetGateway" }
                        }
                      },

                      "PrivateRoute" : {
                        "Type" : "AWS::EC2::Route",
                        "Properties" : {
                          "RouteTableId" : { "Ref" : "PrivateRouteTable" },
                          "DestinationCidrBlock" : "0.0.0.0/0",
                          "InstanceId" : { "Ref" : "NAT" }
                        }
                      },
                      "PublicSubnetRouteTableAssociation1" : {
                            "Type" : "AWS::EC2::SubnetRouteTableAssociation",
                            "Properties" : {
                              "SubnetId" : { "Ref" : "PublicSubnet1" },
                              "RouteTableId" : { "Ref" : "PublicRouteTable" }
                            }
                          },

                          "PublicSubnetRouteTableAssociation2" : {
                            "Type" : "AWS::EC2::SubnetRouteTableAssociation",
                            "Properties" : {
                              "SubnetId" : { "Ref" : "PublicSubnet2" },
                              "RouteTableId" : { "Ref" : "PublicRouteTable" }
                            }
                          },

                          "PrivateSubnetRouteTableAssociation1" : {
                            "Type" : "AWS::EC2::SubnetRouteTableAssociation",
                            "Properties" : {
                              "SubnetId" : { "Ref" : "PrivateSubnet1" },
                              "RouteTableId" : { "Ref" : "PrivateRouteTable" }
                            }
                          },
                          "PrivateSubnetRouteTableAssociation2" : {
                            "Type" : "AWS::EC2::SubnetRouteTableAssociation",
                            "Properties" : {
                              "SubnetId" : { "Ref" : "PrivateSubnet2" },
                              "RouteTableId" : { "Ref" : "PrivateRouteTable" }
                            }
                          },
                          "PublicSubnetAcl" : {
                                "Type" : "AWS::EC2::NetworkAcl",
                                "Properties" : {
                                  "VpcId" : {"Ref" : "VPC"}
                                }
                              },
                              "PrivateSubnetAcl" : {
                                "Type" : "AWS::EC2::NetworkAcl",
                                "Properties" : {
                                  "VpcId" : {"Ref" : "VPC"}
                                }
                              },
                              "PublicInSubnetAclEntry" : {
                                    "Type" : "AWS::EC2::NetworkAclEntry",
                                    "Properties" : {
                                      "NetworkAclId" : {"Ref" : "PublicSubnetAcl"},
                                      "RuleNumber" : "32000",
                                      "Protocol" : "-1",
                                      "RuleAction" : "allow",
                                      "Egress" : "false",
                                      "CidrBlock" : "0.0.0.0/0",
                                      "Icmp" : { "Code" : "-1", "Type" : "-1"},
                                      "PortRange" : {"From" : "1", "To" : "65535"}
                                    }
                                  },

                                  "PublicOutSubnetAclEntry" : {
                                    "Type" : "AWS::EC2::NetworkAclEntry",
                                    "Properties" : {
                                      "NetworkAclId" : {"Ref" : "PublicSubnetAcl"},
                                      "RuleNumber" : "32000",
                                      "Protocol" : "-1",
                                      "RuleAction" : "allow",
                                      "Egress" : "true",
                                      "CidrBlock" : "0.0.0.0/0",
                                      "Icmp" : { "Code" : "-1", "Type" : "-1"},
                                      "PortRange" : {"From" : "1", "To" : "65535"}
                                    }
                                  },

                                  "PrivateInSubnetAclEntry" : {
                                    "Type" : "AWS::EC2::NetworkAclEntry",
                                    "Properties" : {
                                      "NetworkAclId" : {"Ref" : "PrivateSubnetAcl"},
                                      "RuleNumber" : "32000",
                                      "Protocol" : "-1",
                                      "RuleAction" : "allow",
                                      "Egress" : "false",
                                      "CidrBlock" : "0.0.0.0/0",
                                      "Icmp" : { "Code" : "-1", "Type" : "-1"},
                                      "PortRange" : {"From" : "1", "To" : "65535"}
                                    }
                                  },

                                  "PrivateOutSubnetAclEntry" : {
                                    "Type" : "AWS::EC2::NetworkAclEntry",
                                    "Properties" : {
                                      "NetworkAclId" : {"Ref" : "PrivateSubnetAcl"},
                                      "RuleNumber" : "32000",
                                      "Protocol" : "-1",
                                      "RuleAction" : "allow",
                                      "Egress" : "true",
                                      "CidrBlock" : "0.0.0.0/0",
                                      "Icmp" : { "Code" : "-1", "Type" : "-1"},
                                      "PortRange" : {"From" : "1", "To" : "65535"}
                                    }
                                  },
